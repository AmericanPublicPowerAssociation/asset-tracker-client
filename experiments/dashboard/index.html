<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
<link rel="stylesheet" href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.52.0/mapbox-gl.css">
<link rel="stylesheet" href="third-party/simTree.css">
<title>Asset Tracker</title>
<style>
html, body {
  height: 100%;
}
body {
  padding-top: 3.5rem;
}
.container-fluid {
  padding-left: 0;
}
#filter ul {
  padding-left: 0;
}
#map {
  height: 500px;
}
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light fixed-top">
<a class="navbar-brand" href="#">Asset Tracker</a>
<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation" aria-controls="navigation" aria-expanded="false" aria-label="Toggle Navigation">
<span class="navbar-toggler-icon"></span>
</button>

<div class="collapse navbar-collapse" id="navigation">

<form class="form-inline mr-2 my-2 my-lg-0">
<input class="form-control mr-sm-2" type="text" placeholder="Search" aria-label="Search">
<button class="btn btn-outline-primary my-2 my-sm-0" type="submit">Search</button>
</form>

<ul class="navbar-nav mr-auto">

<li class="nav-item active">
<a class="nav-link" href="#">Maps <span class="sr-only">(Current)</span></a>
</li>

<li class="nav-item">
<a class="nav-link" href="#">Tables</a>
</li>

<li class="nav-item">
<a class="nav-link" href="#">Reports</a>
</li>

<li class="nav-item">
<a class="nav-link" href="#">Alerts</a>
</li>

</ul>

<ul class="navbar-nav mr-2">
<li class="nav-item"><a class="nav-link" href="#">Alex</a></li>
</ul>

<button id="button-sign-out" class="btn btn-primary my-2 my-sm-0" type="submit">Sign Out</button>

</div>
</nav>

<main role="main" class="container-fluid h-100">
<div class="row h-100">
<div class="col-8 h-100">

<div class="row h-100">
<div id="map" class="col-10 h-100">
</div>
<div id="filter" class="col-2">
</div>
</div>

</div>
<div id="detail" class="col-4 h-100">
<div id="circuit" class="h-50">
</div>
<div id="information">
<div>Asset Name</div>
<div>Asset ID</div>
</div>
</div>
</div>
</main>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
<script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.52.0/mapbox-gl.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.2.22/cytoscape.min.js"></script>
<script src="third-party/simTree.js"></script>
<script src="substation.js"></script>
<script src="quality.js"></script>
<script src="switch.js"></script>
<script src="transformer.js"></script>
<script src="meter.js"></script>
<script src="line.js"></script>
<script>
mapboxgl.accessToken = 'pk.eyJ1Ijoicm1ndWFyYWNoaSIsImEiOiJjamwzdDdseXcyNTk5M3Fuc3p2ZzJmdXdlIn0.cjtHea9XjbVzu7IQDIXsog';
var map = new mapboxgl.Map({
  container: 'map',
  center: [-79.60975239966413, 36.20116405881477],
  zoom: 9,
  style: 'mapbox://styles/mapbox/basic-v9',
  logoPosition: 'top-right'
});
map.on('load', function() {
  map.loadImage('third-party/substation.png', function(error, image) {
    map.addImage('substation', image);
    map.addLayer({
      'id': 'substation',
      'type': 'symbol',
      'source': {
        'type': 'geojson',
        'data': substation_geojson
      },
      'layout': {
        'icon-image': 'substation',
        'icon-size': 0.5
      }
    });
  });
  map.loadImage('third-party/quality.png', function(error, image) {
    map.addImage('quality', image);
    map.addLayer({
      'id': 'quality',
      'type': 'symbol',
      'source': {
        'type': 'geojson',
        'data': quality_geojson
      },
      'layout': {
        'icon-image': 'quality',
        'icon-size': 0.5
      }
    });
  });
  map.loadImage('third-party/switch.jpg', function(error, image) {
    map.addImage('switch', image);
    map.addLayer({
      'id': 'switch',
      'type': 'symbol',
      'source': {
        'type': 'geojson',
        'data': switch_geojson
      },
      'layout': {
        'icon-image': 'switch',
        'icon-size': 0.5
      }
    });
  });
  map.loadImage('third-party/transformer.png', function(error, image) {
    map.addImage('transformer', image);
    map.addLayer({
      'id': 'transformer',
      'type': 'symbol',
      'source': {
        'type': 'geojson',
        'data': transformer_geojson
      },
      'layout': {
        'icon-image': 'transformer',
        'icon-size': 0.5
      }
    });
  });
  map.loadImage('third-party/meter.png', function(error, image) {
    map.addImage('meter', image);
    map.addLayer({
      'id': 'meter',
      'type': 'symbol',
      'source': {
        'type': 'geojson',
        'data': meter_geojson
      },
      'layout': {
        'icon-image': 'meter',
        'icon-size': 0.5
      }
    });
  });
  map.addLayer({
    'id': 'line',
    'type': 'line',
    'source': {
      'type': 'geojson',
      'data': line_geojson
    },
    'paint': {
      'line-width': ['*', ['get', 'NomV'], 0.1],
      /*
      'line-color': ['match', ['get', 'Phases'],
        'A', '#fbb03b',
        'B', '#223b53',
        'C', '#e55e5e',
        'ABC', '#3bb2d0']
      */
    }
  });
  map.addControl(new mapboxgl.NavigationControl());
});

var cy = cytoscape({
  container: $('#circuit'),
  elements: [
    {data: {id: 'a'}},
    {data: {id: 'b'}},
    {data: {id: 'ab', source: 'a', target: 'b'}}
  ],
  style: [
    {selector: 'node', style: {'background-color': '#666', 'label': 'data(id)'}},
    {selector: 'edge', style: {'width': 3, 'line-color': '#ccc'}}
  ],
  layout: {name: 'grid', rows: 1}
});

$('#filter').simTree({
  data: [
    {'id': 0, 'name': 'Station', 'disabled': true},
    {'id': 1, 'name': 'Substation', 'open': true, 'checked': true},
    {'id': 1.1, 'pid': 1, 'name': 'Transmission', 'disabled': true},
    {'id': 1.2, 'pid': 1, 'name': 'Distribution', 'disabled': true},
    {'id': 2, 'name': 'Quality', 'open': true, 'checked': true},
    {'id': 2.1, 'pid': 2, 'name': 'Capacitor', 'disabled': true},
    {'id': 2.2, 'pid': 2, 'name': 'Regulator', 'disabled': true},
    {'id': 2.3, 'pid': 2, 'name': 'Booster', 'disabled': true},
    {'id': 3, 'name': 'Switch', 'open': true, 'checked': true},
    {'id': 3.1, 'pid': 3, 'name': 'Fuse', 'disabled': true},
    {'id': 3.2, 'pid': 3, 'name': 'Breaker', 'disabled': true},
    {'id': 3.3, 'pid': 3, 'name': 'Recloser', 'disabled': true},
    {'id': 3.4, 'pid': 3, 'name': 'Interrupter', 'disabled': true},
    {'id': 3.5, 'pid': 3, 'name': 'Sectionalizer', 'disabled': true},
    {'id': 3.6, 'pid': 3, 'name': 'Relay', 'disabled': true},
    {'id': 4, 'name': 'Transformer', 'open': true, 'checked': true},
    {'id': 4.1, 'pid': 4, 'name': 'Distribution', 'disabled': true},
    {'id': 5, 'name': 'Meter', 'open': true, 'checked': true},
    {'id': 5.1, 'pid': 5, 'name': 'Residential', 'disabled': true},
    {'id': 5.2, 'pid': 5, 'name': 'Commercial', 'disabled': true},
    {'id': 5.3, 'pid': 5, 'name': 'Industrial', 'disabled': true},
    {'id': 6, 'name': 'Line', 'checked': true},
    {'id': 7, 'name': 'Pole'},
    {'id': 8, 'name': 'Busbar', 'disabled': true},
    {'id': 9, 'name': 'Control', 'disabled': true, 'open': true},
    {'id': 9.1, 'pid': 9, 'name': 'PLC', 'disabled': true},
    {'id': 9.2, 'pid': 9, 'name': 'Microcontroller', 'disabled': true},
    {'id': 10, 'name': 'Miscellaneous'}],
  check: true,
  linkParent: true,
  onChange: function (item) {
    const layer_ids = [
      'substation',
      'quality',
      'switch',
      'transformer',
      'meter',
      'line',
    ];
    let d_by_layer_id = {};
    for (const d of item) {
      const layer_id = d['name'].toLowerCase();
      d_by_layer_id[layer_id] = d;
    }
    for (const layer_id of layer_ids) {
      if (layer_id in d_by_layer_id) {
        map.setLayoutProperty(layer_id, 'visibility', 'visible');
      } else {
        map.setLayoutProperty(layer_id, 'visibility', 'none');
      }
    }
  }
});
</script>
</body>
</html>
